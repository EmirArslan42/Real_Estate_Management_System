<div class="container mt-4">

    <div *ngIf="successMessage" class="fixed-top d-flex justify-content-end" style="margin-top: 20px;right:12px">
        <p class="alert alert-success alert-dismissible fade show text-center w-25 fs-6" role="alert">
            {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="fixed-top d-flex justify-content-end" style="margin-top: 20px;right:12px">
        <p class="alert alert-danger alert-dismissible fade show text-center w-25 fs-6" role="alert">
            {{ errorMessage }}
        </p>
    </div>
    <div class="row  mb-3">

        <!--SOL: FİLTRE -->
        <div class="col-md-12 align-items-end">
            <div class="card mb-3" [formGroup]="filterForm">
                <div class="card-header"><b>Filtrele</b></div>

                <div class="card-body row g-2">
                    <div class="col-md-1">
                        <input class="form-control" placeholder="İl" formControlName="il">
                    </div>

                    <div class="col-md-1">
                        <input class="form-control" placeholder="İlçe" formControlName="ilce">
                    </div>

                    <div class="col-md-2">
                        <input class="form-control" placeholder="Mahalle" formControlName="mahalle">
                    </div>

                    <div class="col-md-3">
                        <input class="form-control" placeholder="Adres" formControlName="address">
                    </div>

                    <div *ngIf="isAdmin" class="col-md-2">
                        <input class="form-control" placeholder="Kullanıcı (email)" formControlName="user">
                    </div>

                    <div class="col-md-1">
                        <button (click)="clearFilterForm()" class="btn btn-danger w-100">
                            Temizle
                        </button>
                    </div>

                    <div class="col-md-1">
                        <button class=" btn btn-warning w-100" (click)="exportExcel()">
                            Excel
                        </button>
                    </div>

                    <div class="col-md-1">
                        <button class="btn btn-warning w-100" (click)="exportPdf()">
                            PDF
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <div id="contentToConvert">
        <div class="d-flex justify-content-between align-items-center gap-3">
            <button *ngIf="!isAdmin" class="btn btn-primary mb-3" routerLink="/dashboard/tasinmaz/add">Yeni Taşınmaz
                Ekle</button>
            <h2 class="text-center">Taşınmaz Listesi</h2>
            <input type="file" class="form-control w-auto" accept=".xlsx,.xls" (change)="onExcelUpload($event)">
        </div>
        <br>
        <table class="table table-bordered" *ngIf="!isLoading && filteredTasinmazlar.length >0">
            <caption class="visually-hidden">
                Sistemde kayıtlı taşınmazların ada, parsel ve konum bilgileriyle listelendiği tablo
            </caption>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Ada</th>
                    <th>Parsel</th>
                    <th>İl</th>
                    <th>İlçe</th>
                    <th>Mahalle</th>
                    <th>Resim</th>
                    <th>Adres</th>
                    <th *ngIf="isAdmin">Kullanıcı</th>
                    <th *ngIf="!isAdmin" class="text-center">İşlemler</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngFor="let tasinmaz of filteredTasinmazlar">
                    <td>{{tasinmaz.id}}</td>
                    <td>{{tasinmaz.lotNumber}}</td>
                    <td>{{tasinmaz.parcelNumber}}</td>
                    <td>{{tasinmaz.ilAdi}}</td>
                    <td>{{tasinmaz.ilceAdi}}</td>
                    <td>{{tasinmaz.mahalleAdi}}</td>
                    <td class="text-center">
                        <img *ngIf="tasinmaz.id"
                            [src]="'https://localhost:7040/api/Tasinmaz/'+tasinmaz.id+'/image?ts=' + imageTimestamp"
                            [alt]="'Taşınmaz ' + tasinmaz.ilAdi + ' ' + tasinmaz.ilceAdi + ' ' + tasinmaz.mahalleAdi + ' görseli'"
                            width="80" />
                    </td>
                    <td>{{tasinmaz.address}}</td>
                    <td *ngIf="isAdmin">{{tasinmaz.userEmail}}</td>
                    <td *ngIf="!isAdmin" class="d-flex justify-content-center gap-3 ">
                        <button *ngIf="!isAdmin" class="btn btn-warning btn-md "
                            (click)="editTasinmaz(tasinmaz.id)">Düzenle</button>
                        <button *ngIf="!isAdmin" class="btn btn-danger btn-md px-"
                            (click)="deleteTasinmaz(tasinmaz.id)">Sil</button>
                    </td>

                </tr>
            </tbody>
        </table>
    </div>
    <div *ngIf="!isLoading && filteredTasinmazlar.length==0 && tasinmazlar.length!=0" class="alert alert-info">
        Filtrelerinize uygun taşınmaz bulunamadı !
    </div>
    <div *ngIf="!isLoading && tasinmazlar.length==0 && !isAdmin" class="alert alert-info">Hiç taşınmaz bulunamadı !
    </div>
    <hr><br>
    <div class="mb-4" style="height: 400px; border: 1px solid #ccc;">
        <app-tasinmaz-map [allTasinmazlar]="tasinmazlar"
            (tasinmazSelected)="onTasinmazSelected($event)"></app-tasinmaz-map>
    </div>

    <div *ngIf="selectedTasinmaz" class="alert alert-success">
        <div class="popup-header ">
            <strong>Taşınmaz Bilgileri</strong>
            <button class="btn-close" (click)="closePopup()"></button>
        </div>

        <div class="popup-body">
            <p><b>Ada:</b> {{ selectedTasinmaz.lotNumber }}</p>
            <p><b>Parsel:</b> {{ selectedTasinmaz.parcelNumber }}</p>
            <p><b>Adres:</b> {{ selectedTasinmaz.address }}</p>
            <p><b>Koordinat:</b></p>
            <small>{{ formatCoordinates(selectedTasinmaz.geometry )}}</small>
        </div>
    </div>

</div>